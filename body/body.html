<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Body Encyclopedia & Quiz</title>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f6f7fb; color: #222; }
    header { background: #2d3a4b; color: #fff; padding: 1.2rem 2rem; text-align: center; font-size: 2rem; letter-spacing: 2px; box-shadow: 0 2px 8px #0001; }
    nav { display: flex; justify-content: center; gap: 2rem; margin: 2rem 0 1rem 0; }
    nav button { background: #fff; border: 2px solid #2d3a4b; color: #2d3a4b; padding: 0.7rem 2.2rem; font-size: 1.2rem; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
    nav button.active, nav button:hover { background: #2d3a4b; color: #fff; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 16px #0002; padding: 2rem; min-height: 400px; }
    .hidden { display: none !important; }
    .quiz-image-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem; }
    .quiz-image { width: 320px; height: 220px; object-fit: contain; border-radius: 12px; box-shadow: 0 2px 12px #0002; background: #f0f0f0; margin-bottom: 0.5rem; transition: box-shadow 0.2s; cursor: pointer; }
    .switch-img-btn { background: #e0e4ea; border: none; color: #2d3a4b; padding: 0.3rem 1.2rem; border-radius: 12px; cursor: pointer; margin-bottom: 1rem; margin-top: 0.2rem; font-size: 1rem; transition: background 0.2s; }
    .switch-img-btn:hover { background: #c2c7d2; }
    .quiz-input-area { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1.5rem; position: relative; }
    .autocomplete-list {
      border: 1px solid #bbb;
      background: #fff;
      border-radius: 8px;
      max-height: 180px;
      overflow-y: auto;
      position: absolute;
      width: 90%;
      left: 50%;
      transform: translateX(-50%);
      top: 2.8em;
      z-index: 30;
      box-shadow: 0 2px 8px #0002;
    }
    .autocomplete-item { padding: 0.5rem 1rem; cursor: pointer; }
    .autocomplete-item:hover, .autocomplete-item.selected { background: #e0e4ea; }
    .quiz-feedback { font-size: 1.2rem; margin: 1rem 0; min-height: 1.5em; }
    .quiz-timer { font-size: 1.3rem; color: #d13a3a; margin-bottom: 1rem; font-weight: bold; }
    .results-summary { font-size: 1.4rem; margin-bottom: 1.5rem; text-align: center; }
    .results-list { display: flex; flex-direction: column; gap: 1.2rem; }
    .result-item { display: flex; align-items: center; gap: 1rem; background: #f6f7fb; border-radius: 10px; padding: 0.7rem 1rem; box-shadow: 0 1px 4px #0001; cursor: pointer; position: relative; }
    .result-img-thumb { width: 60px; height: 40px; object-fit: cover; border-radius: 8px; border: 1px solid #bbb; background: #eee; }
    .result-details { flex: 1; display: flex; flex-direction: column; gap: 0.2rem; }
    .result-correct { color: #2c8c2c; font-weight: bold; }
    .result-wrong { color: #d13a3a; font-weight: bold; }
    .modal-bg, .encyclo-modal-bg {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: #0006; z-index: 2000; display: flex; align-items: center; justify-content: center;
    }
    .modal-bg { z-index: 3000; }
    .modal-img {
      background: #fff;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 2px 24px #0003;
      max-width: 80vw;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .modal-img img {
      max-width: 70vw;
      max-height: 60vh;
      border-radius: 12px;
      margin-bottom: 1rem;
      background: #eee;
    }
    .close-modal-btn, .close-encyclo-modal-btn {
      background: #2d3a4b;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0.5rem 1.2rem;
      font-size: 1.1rem;
      cursor: pointer;
      margin-top: 0.5rem;
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 2;
    }
    .encyclo-modal-bg {
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    .encyclo-modal {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 24px #0003;
      width: 520px;
      max-width: 96vw;
      height: 600px;
      max-height: 96vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      position: relative;
      overflow: hidden;
      padding: 0;
      z-index: 2100;
    }
    .encyclo-modal-content-scroll {
      overflow-y: auto;
      padding: 2.5rem 1.5rem 1.5rem 1.5rem;
      flex: 1 1 auto;
    }
    .encyclo-modal .close-encyclo-modal-btn {
      z-index: 2;
      margin-top: 0;
      margin-right: 0;
      padding: 0.4rem 1.1rem;
      font-size: 1.1rem;
      top: 0.7rem;
      right: 0.7rem;
    }
    .options-form { display: flex; flex-direction: column; gap: 1.5rem; max-width: 440px; margin: 0 auto; padding-top: 2rem; }
    .options-form label { font-size: 1.1rem; margin-bottom: 0.3rem; display: block; }
    .options-form input[type="number"] { width: 80px; padding: 0.4rem; font-size: 1.1rem; border-radius: 8px; border: 1px solid #bbb; }
    .options-form input[type="checkbox"] { margin-right: 0.6rem; }
    .options-form button { background: #2d3a4b; color: #fff; border: none; border-radius: 12px; padding: 0.7rem 1.6rem; font-size: 1.1rem; cursor: pointer; margin-top: 1rem; }
    .encyclopedia-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
    .encyclopedia-table th, .encyclopedia-table td { border: 1px solid #e0e4ea; padding: 0.7rem 0.5rem; text-align: left; background: #f6f7fb; }
    .encyclopedia-table th { background: #2d3a4b; color: #fff; cursor: pointer; user-select: none; }
    .encyclopedia-table th.sorted-asc::after { content: " ▲"; }
    .encyclopedia-table th.sorted-desc::after { content: " ▼"; }
    .encyclopedia-table tr:hover { background: #e0e4ea; }
    .gallery-section { margin-top: 1.5rem; }
    .gallery-title { font-weight: bold; margin-bottom: 0.7rem; font-size: 1.1rem; }
    .gallery-images { display: flex; gap: 1.2rem; flex-wrap: wrap; }
    .gallery-img-container { position: relative; display: flex; flex-direction: column; align-items: center; margin-bottom: 1rem; }
    .gallery-img { width: 120px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #bbb; background: #eee; margin-bottom: 0.2rem; cursor: pointer; transition: box-shadow 0.2s; }
    .gallery-switch-btn { background: #e0e4ea; border: none; color: #2d3a4b; padding: 0.2rem 0.7rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin-bottom: 0.2rem; margin-top: 0.1rem; }
    .gallery-switch-btn:hover { background: #c2c7d2; }
    @media (max-width: 600px) {
      .container { padding: 0.5rem; }
      .quiz-image { width: 98vw; height: auto; }
      .gallery-img { width: 80px; height: 60px; }
      .encyclo-modal { width: 98vw; height: 98vh; }
    }
  </style>
</head>
<body>
<header>Body Encyclopedia & Quiz</header>
<nav>
  <button id="nav-quiz" class="active">Quiz</button>
  <button id="nav-options">Options</button>
  <button id="nav-encyclopedia">Encyclopedia</button>
</nav>
<div class="container">
  <!-- Quiz Section -->
  <section id="section-quiz">
    <div id="quiz-timer" class="quiz-timer hidden"></div>
    <div id="quiz-image-container" class="quiz-image-container"></div>
    <div class="quiz-input-area">
      <input id="quiz-answer" type="text" placeholder="Type or select the name..." autocomplete="off" style="font-size:1.1rem; padding:0.5rem; width:90%; border-radius:8px; border:1px solid #bbb;">
      <div id="autocomplete-list" class="autocomplete-list hidden"></div>
      <button id="quiz-submit-btn" style="margin-top:0.5rem;padding:0.5rem 2rem;font-size:1.1rem; border-radius:12px; background:#2d3a4b;color:#fff;border:none;cursor:pointer;">Confirm</button>
    </div>
    <div id="quiz-feedback" class="quiz-feedback"></div>
  </section>
  <!-- Results Section -->
  <section id="section-results" class="hidden">
    <div id="results-summary" class="results-summary"></div>
    <div id="results-list" class="results-list"></div>
    <button id="results-restart-btn" style="margin-top:2rem;padding:0.7rem 2rem;font-size:1.1rem; border-radius:12px; background:#2d3a4b;color:#fff;border:none;cursor:pointer;">Restart Quiz</button>
  </section>
  <!-- Options Section -->
  <section id="section-options" class="hidden">
    <form id="options-form" class="options-form">
      <div>
        <label for="opt-num-questions">Number of questions:</label>
        <input type="number" id="opt-num-questions" min="1" max="30" value="10">
      </div>
      <div>
        <label>
          <input type="checkbox" id="opt-timer-enabled">
          Enable timer per question
        </label>
        <div id="timer-settings" class="hidden" style="margin-left:2rem;">
          <label for="opt-timer-seconds">Time per question (seconds):</label>
          <input type="number" id="opt-timer-seconds" min="5" max="120" value="30">
        </div>
      </div>
      <button type="submit">Save Options</button>
    </form>
  </section>
  <!-- Encyclopedia Section -->
  <section id="section-encyclopedia" class="hidden">
    <table class="encyclopedia-table">
      <thead>
        <tr>
          <th id="sort-name" class="sorted-asc">Name</th>
          <th id="sort-type">Type</th>
        </tr>
      </thead>
      <tbody id="encyclopedia-list"></tbody>
    </table>
  </section>
</div>
<!-- Modal for large images -->
<div id="modal-bg" class="modal-bg hidden">
  <div class="modal-img">
    <img id="modal-img" src="" alt="Large view">
    <button class="close-modal-btn" onclick="closeModal()">Close</button>
  </div>
</div>
<!-- Modal for encyclopedia info -->
<div id="encyclo-modal-bg" class="encyclo-modal-bg hidden">
  <div class="encyclo-modal">
    <button class="close-encyclo-modal-btn" onclick="closeEncycloModal()">Close</button>
    <div class="encyclo-modal-content-scroll" id="encyclo-modal-content"></div>
  </div>
</div>
<script>
const GITHUB_RAW_BASE = "https://raw.githubusercontent.com/larbaretier/drawing/main/body/";
const BODY_JSON_URL = GITHUB_RAW_BASE + "body.json";
const IMAGE_PATHS_JSON_URL = GITHUB_RAW_BASE + "image_paths.json";
const ORIGINAL_IMAGES_FOLDER = GITHUB_RAW_BASE + "original_images/";
const SUBFOLDERS = ['cartoon', 'realist', 'photo'];

let bodyList = [];
let nameToElement = {};
let quizOptions = { numQuestions: 10, timerEnabled: false, timerSeconds: 30 };
let quizState = null;
let encyclopediaSort = { by: 'name', asc: true };
let imageManifest = [];
let imagesByElement = {}; // { nom: { cartoon: [imgObj], realist: [], photo: [] } }
let quizTimerInterval = null;
let encycloModalOpen = false;

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function normalizeName(str) {
  // Lowercase, replace spaces with underscores, remove accents
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "_").toLowerCase();
}
function getOriginalImagePath(imgFile) {
  const base = imgFile.split('_')[0];
  const ext = imgFile.slice(imgFile.lastIndexOf('.'));
  return `${ORIGINAL_IMAGES_FOLDER}${base}${ext}`;
}
function getRawUrlFromManifestPath(path) {
  return GITHUB_RAW_BASE + path.replace(/\\/g, '/');
}
function parseManifest() {
  imagesByElement = {};
  for (const path of imageManifest) {
    const parts = path.split(/[/\\]/);
    if (parts.length < 4) continue;
    const nom = normalizeName(parts[1]);
    const sub = parts[2];
    const file = parts[3];
    if (!imagesByElement[nom]) imagesByElement[nom] = { cartoon: [], realist: [], photo: [] };
    if (SUBFOLDERS.includes(sub)) {
      imagesByElement[nom][sub].push({
        file,
        url: getRawUrlFromManifestPath(path)
      });
    }
  }
}

window.addEventListener('DOMContentLoaded', async () => {
  showLoading("Loading data...");
  await loadBodyJson();
  await loadImageManifest();
  parseManifest();
  setupNav();
  setupQuiz();
  setupOptions();
  setupEncyclopedia();
  hideLoading();
  showSection('quiz');
});

async function loadBodyJson() {
  const resp = await fetch(BODY_JSON_URL);
  bodyList = await resp.json();
  nameToElement = {};
  for (const elem of bodyList) nameToElement[elem.nom] = elem;
}
async function loadImageManifest() {
  const resp = await fetch(IMAGE_PATHS_JSON_URL);
  imageManifest = await resp.json();
}

function setupNav() {
  document.getElementById('nav-quiz').onclick = () => showSection('quiz');
  document.getElementById('nav-options').onclick = () => showSection('options');
  document.getElementById('nav-encyclopedia').onclick = () => showSection('encyclopedia');
}

function showSection(section) {
  document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
  document.getElementById('nav-' + section).classList.add('active');
  document.getElementById('section-quiz').classList.toggle('hidden', section !== 'quiz');
  document.getElementById('section-results').classList.add('hidden');
  document.getElementById('section-options').classList.toggle('hidden', section !== 'options');
  document.getElementById('section-encyclopedia').classList.toggle('hidden', section !== 'encyclopedia');
  if (section === 'quiz') startQuiz();
  if (section === 'encyclopedia') renderEncyclopediaTable();
}

/** --- LOADING INDICATOR --- **/
function showLoading(msg) {
  let el = document.getElementById('loading-indicator');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loading-indicator';
    el.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:#fff9f9ee;z-index:9999;display:flex;align-items:center;justify-content:center;font-size:2rem;";
    document.body.appendChild(el);
  }
  el.textContent = msg || "Loading...";
  el.style.display = 'flex';
}
function hideLoading() {
  let el = document.getElementById('loading-indicator');
  if (el) el.style.display = 'none';
}

/** --- QUIZ --- **/
function setupQuiz() {
  document.getElementById('quiz-submit-btn').onclick = () => submitQuizAnswer();
  document.getElementById('quiz-answer').addEventListener('input', debounce(showAutocomplete, 100));
  document.getElementById('quiz-answer').addEventListener('focus', showAutocomplete);
  document.addEventListener('click', e => {
    if (!e.target.closest('.quiz-input-area')) hideAutocomplete();
  });
}
function startQuiz() {
  // Build all possible (element, image) pairs
  let candidates = [];
  let elementImages = {}; // {nom: [imgObj,...]}
  bodyList.forEach(el => {
    const nomNorm = normalizeName(el.nom);
    const imgs = [];
    for (const sub of SUBFOLDERS) {
      imgs.push(...((imagesByElement[nomNorm]?.[sub]) || []).map(img => ({...img, sub})));
    }
    if (imgs.length) elementImages[nomNorm] = imgs;
  });
  const elementNames = Object.keys(elementImages);
  if (elementNames.length === 0) {
    document.getElementById('quiz-image-container').innerHTML = "<b>No elements with images found.</b>";
    document.querySelector('.quiz-input-area').style.display = "none";
    return;
  }
  // Build the quiz questions list
  const numQuestions = quizOptions.numQuestions;
  const questions = [];
  const usedImages = {}; // {nom: Set(imgUrl)}
  // 1. First, pick as many unique elements as possible
  let availableElements = shuffle([...elementNames]);
  for (let i = 0; i < Math.min(numQuestions, availableElements.length); i++) {
    const nom = availableElements[i];
    const imgs = shuffle([...elementImages[nom]]);
    const img = imgs[0];
    const el = bodyList.find(e => normalizeName(e.nom) === nom);
    questions.push({ element: el, img });
    usedImages[nom] = new Set([img.url]);
  }
  // 2. If more questions needed, allow repeats, but prefer unused images for each element
  while (questions.length < numQuestions) {
    const nom = shuffle([...elementNames])[0];
    const imgs = elementImages[nom];
    let img = null;
    const usedSet = usedImages[nom] || new Set();
    const unusedImgs = imgs.filter(im => !usedSet.has(im.url));
    if (unusedImgs.length) {
      img = shuffle([...unusedImgs])[0];
    } else {
      img = shuffle([...imgs])[0];
    }
    const el = bodyList.find(e => normalizeName(e.nom) === nom);
    questions.push({ element: el, img });
    if (!usedImages[nom]) usedImages[nom] = new Set();
    usedImages[nom].add(img.url);
  }
  quizState = {
    questions,
    current: 0,
    score: 0,
    answers: [],
    timer: null,
    timerLeft: 0
  };
  document.querySelector('.quiz-input-area').style.display = "";
  renderQuizQuestion();
}
function renderQuizQuestion() {
  if (quizTimerInterval) clearInterval(quizTimerInterval);
  const qIdx = quizState.current;
  if (qIdx >= quizState.questions.length) {
    showQuizResults();
    return;
  }
  const {element, img} = quizState.questions[qIdx];
  quizState.currentImg = {
    path: img.url,
    file: img.file,
    sub: img.sub,
    nom: element.nom,
    original: getOriginalImagePath(img.file)
  };
  // Render image
  const imgCont = document.getElementById('quiz-image-container');
  imgCont.innerHTML = `
    <img src="${quizState.currentImg.path}" class="quiz-image" id="quiz-main-img" alt="Quiz Image" title="Click to enlarge">
    <button class="switch-img-btn" id="quiz-switch-img-btn">Show Original</button>
  `;
  let showingOriginal = false;
  document.getElementById('quiz-switch-img-btn').onclick = () => {
    const img = document.getElementById('quiz-main-img');
    if (!showingOriginal) {
      img.src = quizState.currentImg.original;
      document.getElementById('quiz-switch-img-btn').textContent = 'Show Variant';
      showingOriginal = true;
    } else {
      img.src = quizState.currentImg.path;
      document.getElementById('quiz-switch-img-btn').textContent = 'Show Original';
      showingOriginal = false;
    }
  };
  document.getElementById('quiz-main-img').onclick = () => {
    showModal(quizState.currentImg.path, true);
  };
  // Timer
  if (quizOptions.timerEnabled) {
    quizState.timerLeft = quizOptions.timerSeconds;
    document.getElementById('quiz-timer').classList.remove('hidden');
    updateQuizTimer();
    quizTimerInterval = setInterval(() => {
      quizState.timerLeft--;
      updateQuizTimer();
      if (quizState.timerLeft <= 0) {
        clearInterval(quizTimerInterval);
        submitQuizAnswer(true);
      }
    }, 1000);
  } else {
    document.getElementById('quiz-timer').classList.add('hidden');
    if (quizTimerInterval) clearInterval(quizTimerInterval);
  }
  // Reset input
  const input = document.getElementById('quiz-answer');
  input.value = '';
  input.focus();
  document.getElementById('quiz-feedback').textContent = '';
  hideAutocomplete();
}
function updateQuizTimer() {
  document.getElementById('quiz-timer').textContent = `⏳ ${quizState.timerLeft}s`;
}
function submitQuizAnswer(timeout=false) {
  if (quizTimerInterval) clearInterval(quizTimerInterval);
  const input = document.getElementById('quiz-answer');
  const answer = input.value.trim();
  const correct = quizState.questions[quizState.current].element.nom;
  let isCorrect = (answer.toLowerCase() === correct.toLowerCase());
  if (timeout) isCorrect = false;
  quizState.answers.push({
    answer,
    correct,
    isCorrect,
    img: quizState.currentImg
  });
  if (isCorrect) quizState.score++;
  const fb = document.getElementById('quiz-feedback');
  if (isCorrect) {
    fb.innerHTML = `<span style="color:#2c8c2c;font-weight:bold;">Correct!</span>`;
  } else {
    fb.innerHTML = `<span style="color:#d13a3a;font-weight:bold;">Wrong.</span> The correct answer was <b>${escapeHTML(correct)}</b>.`;
  }
  setTimeout(() => {
    quizState.current++;
    renderQuizQuestion();
  }, 1200);
}
function showAutocomplete() {
  const input = document.getElementById('quiz-answer');
  const val = input.value.trim().toLowerCase();
  const list = document.getElementById('autocomplete-list');
  let filtered = bodyList.map(e=>e.nom);
  if (val) filtered = filtered.filter(n => n.toLowerCase().includes(val));
  list.innerHTML = filtered.map(n => `<div class="autocomplete-item">${escapeHTML(n)}</div>`).join('');
  if (filtered.length === 0) list.classList.add('hidden');
  else list.classList.remove('hidden');
  list.querySelectorAll('.autocomplete-item').forEach(item => {
    item.onclick = () => {
      input.value = item.textContent;
      hideAutocomplete();
      input.focus();
    };
  });
}
function hideAutocomplete() {
  document.getElementById('autocomplete-list').classList.add('hidden');
}
function showQuizResults() {
  if (quizTimerInterval) clearInterval(quizTimerInterval);
  document.getElementById('section-quiz').classList.add('hidden');
  document.getElementById('section-results').classList.remove('hidden');
  const score = quizState.score;
  const total = quizState.questions.length;
  let comment = '';
  if (score === total) comment = 'Perfect!';
  else if (score >= total * 0.8) comment = 'Great!';
  else if (score >= total * 0.5) comment = 'Not bad!';
  else comment = 'Oh no!';
  document.getElementById('results-summary').innerHTML = `Score: <b>${score}/${total}</b><br>${comment}`;
  const list = document.getElementById('results-list');
  list.innerHTML = quizState.answers.map((ans, i) => `
    <div class="result-item" data-idx="${i}">
      <img src="${ans.img.path}" class="result-img-thumb" alt="">
      <div class="result-details">
        <div><b>Q${i+1}:</b> ${escapeHTML(ans.correct)}</div>
        <div>Your answer: <b>${escapeHTML(ans.answer||'(none)')}</b></div>
        <div class="${ans.isCorrect?'result-correct':'result-wrong'}">${ans.isCorrect?'Correct':'Wrong'}</div>
      </div>
    </div>
  `).join('');
  list.querySelectorAll('.result-item').forEach(item => {
    item.onclick = () => {
      const idx = item.getAttribute('data-idx');
      showModal(quizState.answers[idx].img.path, true);
    };
  });
  document.getElementById('results-restart-btn').onclick = () => {
    document.getElementById('section-results').classList.add('hidden');
    showSection('quiz');
  };
}

/** --- OPTIONS --- **/
function setupOptions() {
  const form = document.getElementById('options-form');
  const numQ = document.getElementById('opt-num-questions');
  const timerEn = document.getElementById('opt-timer-enabled');
  const timerSet = document.getElementById('timer-settings');
  const timerSec = document.getElementById('opt-timer-seconds');
  timerEn.onchange = () => {
    timerSet.classList.toggle('hidden', !timerEn.checked);
  };
  form.onsubmit = e => {
    e.preventDefault();
    quizOptions.numQuestions = Math.max(1, Math.min(30, +numQ.value));
    quizOptions.timerEnabled = timerEn.checked;
    quizOptions.timerSeconds = Math.max(5, Math.min(120, +timerSec.value));
    alert('Options saved!');
    showSection('quiz');
  };
}

/** --- ENCYCLOPEDIA --- **/
function setupEncyclopedia() {
  document.getElementById('sort-name').onclick = () => {
    encyclopediaSort.by = 'name';
    encyclopediaSort.asc = !encyclopediaSort.asc;
    renderEncyclopediaTable();
  };
  document.getElementById('sort-type').onclick = () => {
    encyclopediaSort.by = 'type';
    encyclopediaSort.asc = !encyclopediaSort.asc;
    renderEncyclopediaTable();
  };
}
function renderEncyclopediaTable() {
  const tbody = document.getElementById('encyclopedia-list');
  let sorted = [...bodyList];
  if (encyclopediaSort.by === 'name') {
    sorted.sort((a,b) => encyclopediaSort.asc ? a.nom.localeCompare(b.nom) : b.nom.localeCompare(a.nom));
  } else {
    sorted.sort((a,b) => encyclopediaSort.asc ? (a.type||'').localeCompare(b.type||'') : (b.type||'').localeCompare(a.type||''));
  }
  document.getElementById('sort-name').className = encyclopediaSort.by==='name'?(encyclopediaSort.asc?'sorted-asc':'sorted-desc'):'';
  document.getElementById('sort-type').className = encyclopediaSort.by==='type'?(encyclopediaSort.asc?'sorted-asc':'sorted-desc'):'';
  tbody.innerHTML = sorted.map(el => `
    <tr class="encyclopedia-row" data-nom="${escapeHTML(el.nom)}">
      <td>${escapeHTML(el.nom)}</td>
      <td>${escapeHTML(el.type||'')}</td>
    </tr>
  `).join('');
  tbody.querySelectorAll('.encyclopedia-row').forEach(row => {
    row.onclick = () => showEncyclopediaInfoModal(row.getAttribute('data-nom'));
  });
}
function showEncyclopediaInfoModal(nom) {
  encycloModalOpen = true;
  const el = nameToElement[nom];
  const modalContent = document.getElementById('encyclo-modal-content');
  let html = `
    <div style="margin-bottom:1rem;">
      <div><b>Name:</b> ${escapeHTML(el.nom)}</div>
      <div><b>Type:</b> ${escapeHTML(el.type||'')}</div>
      <div><b>Categories:</b> ${el.categories.map(escapeHTML).join(', ')}</div>
    </div>
    <div class="gallery-section" style="width:100%;">
      ${SUBFOLDERS.map(sub => renderGallerySectionModal(el, sub)).join('')}
    </div>
  `;
  modalContent.innerHTML = html;
  document.getElementById('encyclo-modal-bg').classList.remove('hidden');
}
function renderGallerySectionModal(el, sub) {
  const nomNorm = normalizeName(el.nom);
  const images = imagesByElement[nomNorm]?.[sub] || [];
  if (!images.length) return '';
  return `
    <div class="gallery-title">${sub.charAt(0).toUpperCase()+sub.slice(1)}</div>
    <div class="gallery-images">
      ${images.map((img, idx) => `
        <div class="gallery-img-container">
          <img src="${img.url}" class="gallery-img" alt="" onclick="showModal('${img.url}', false)">
          <button class="gallery-switch-btn" onclick="event.stopPropagation();switchGalleryImg(this,'${img.url}','${getOriginalImagePath(img.file)}')">Show Original</button>
        </div>
      `).join('')}
    </div>
  `;
}
function closeEncycloModal() {
  encycloModalOpen = false;
  document.getElementById('encyclo-modal-bg').classList.add('hidden');
}
function switchGalleryImg(btn, variant, original) {
  const img = btn.parentNode.querySelector('.gallery-img');
  if (img.src === variant) {
    img.src = original;
    btn.textContent = 'Show Variant';
  } else {
    img.src = variant;
    btn.textContent = 'Show Original';
  }
}
function showModal(imgUrl, fromQuizOrResults) {
  // If encyclopedia modal is open, hide it temporarily
  if (encycloModalOpen) {
    document.getElementById('encyclo-modal-bg').style.display = 'none';
  }
  document.getElementById('modal-img').src = imgUrl;
  document.getElementById('modal-bg').classList.remove('hidden');
}
function closeModal() {
  document.getElementById('modal-bg').classList.add('hidden');
  // Restore encyclopedia modal if it was open
  if (encycloModalOpen) {
    document.getElementById('encyclo-modal-bg').style.display = '';
  }
}
window.closeModal = closeModal;
window.showModal = showModal;
window.switchGalleryImg = switchGalleryImg;
window.closeEncycloModal = closeEncycloModal;

/* Debounce function for autocomplete */
function debounce(fn, delay) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delay);
  };
}
</script>
<div id="loading-indicator" style="display:none"></div>
</body>
</html>
