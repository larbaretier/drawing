<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Body Landmarks Encyclopedia & Quiz</title>
  <style id="main-style">
    body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background: #f6f7fb; color: #222; }
    header { background: #2d3a4b; color: #fff; padding: 1.2rem 2rem 0.5rem 2rem; text-align: center; font-size: 2rem; letter-spacing: 2px; box-shadow: 0 2px 8px #0001; position:relative; }
    nav { display: flex; justify-content: center; gap: 2rem; margin: 2rem 0 1rem 0; }
    nav button { background: #fff; border: 2px solid #2d3a4b; color: #2d3a4b; padding: 0.7rem 2.2rem; font-size: 1.2rem; border-radius: 20px; cursor: pointer; transition: all 0.2s; }
    nav button.active, nav button:hover { background: #2d3a4b; color: #fff; }
    .container { max-width: 900px; margin: 0 auto; background: #fff; border-radius: 16px; box-shadow: 0 2px 16px #0002; padding: 2rem; min-height: 400px; }
    .hidden { display: none !important; }
    .quiz-image-container { display: flex; flex-direction: column; align-items: center; margin-bottom: 1.5rem; }
    .quiz-image { width: 320px; height: 220px; object-fit: contain; border-radius: 12px; box-shadow: 0 2px 12px #0002; background: #f0f0f0; margin-bottom: 0.5rem; transition: box-shadow 0.2s; cursor: pointer; }
    .switch-img-btn { background: #e0e4ea; border: none; color: #2d3a4b; padding: 0.3rem 1.2rem; border-radius: 12px; cursor: pointer; margin-bottom: 1rem; margin-top: 0.2rem; font-size: 1rem; transition: background 0.2s; }
    .switch-img-btn:hover { background: #c2c7d2; }
    .quiz-input-area { display: flex; flex-direction: column; align-items: center; gap: 1rem; margin-bottom: 1.5rem; position: relative; }
    .autocomplete-list {
      border: 1px solid #bbb;
      background: #fff;
      border-radius: 8px;
      max-height: 180px;
      overflow-y: auto;
      position: absolute;
      width: 90%;
      left: 50%;
      transform: translateX(-50%);
      top: 2.8em;
      z-index: 30;
      box-shadow: 0 2px 8px #0002;
    }
    .autocomplete-item { padding: 0.5rem 1rem; cursor: pointer; }
    .autocomplete-item:hover, .autocomplete-item.selected { background: #e0e4ea; }
    .quiz-feedback { font-size: 1.2rem; margin: 1rem 0; min-height: 1.5em; }
    .quiz-timer { font-size: 1.3rem; color: #d13a3a; margin-bottom: 1rem; font-weight: bold; }
    .results-summary { font-size: 1.4rem; margin-bottom: 1.5rem; text-align: center; }
    .results-list { display: flex; flex-direction: column; gap: 1.2rem; }
    .result-item { display: flex; align-items: center; gap: 1rem; background: #f6f7fb; border-radius: 10px; padding: 0.7rem 1rem; box-shadow: 0 1px 4px #0001; cursor: pointer; position: relative; }
    .result-img-thumb { width: 60px; height: 40px; object-fit: cover; border-radius: 8px; border: 1px solid #bbb; background: #eee; }
    .result-details { flex: 1; display: flex; flex-direction: column; gap: 0.2rem; }
    .result-correct { color: #2c8c2c; font-weight: bold; }
    .result-wrong { color: #d13a3a; font-weight: bold; }
    .modal-bg, .encyclo-modal-bg {
      position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
      background: #0006; z-index: 3000; display: flex; align-items: center; justify-content: center;
    }
    .modal-bg { z-index: 4000; }
    .modal-img {
      background: #fff;
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: 0 2px 24px #0003;
      max-width: 80vw;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .modal-img img {
      max-width: 70vw;
      max-height: 60vh;
      border-radius: 12px;
      margin-bottom: 1rem;
      background: #eee;
      cursor: pointer;
    }
    .close-modal-btn, .close-encyclo-modal-btn {
      background: #2d3a4b;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0.5rem 1.2rem;
      font-size: 1.1rem;
      cursor: pointer;
      margin-top: 0.5rem;
      position: absolute;
      top: 1rem;
      right: 1rem;
      z-index: 2;
    }
    .modal-img .modal-img-tip {
      font-size: 1rem;
      color: #444;
      margin-bottom: 0.5rem;
    }
    .encyclo-modal-bg {
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    }
    .encyclo-modal {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 2px 24px #0003;
      width: 520px;
      max-width: 96vw;
      height: 600px;
      max-height: 96vh;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      position: relative;
      overflow: hidden;
      padding: 0;
      z-index: 3100;
    }
    .encyclo-modal-content-scroll {
      overflow-y: auto;
      padding: 2.5rem 1.5rem 1.5rem 1.5rem;
      flex: 1 1 auto;
    }
    .encyclo-modal .close-encyclo-modal-btn {
      z-index: 2;
      margin-top: 0;
      margin-right: 0;
      padding: 0.4rem 1.1rem;
      font-size: 1.1rem;
      top: 0.7rem;
      right: 0.7rem;
    }
    .options-form { display: flex; flex-direction: column; gap: 1.5rem; max-width: 440px; margin: 0 auto; padding-top: 2rem; }
    .options-form label { font-size: 1.1rem; margin-bottom: 0.3rem; display: block; }
    .options-form input[type="number"], .options-form select { width: 120px; padding: 0.4rem; font-size: 1.1rem; border-radius: 8px; border: 1px solid #bbb; }
    .options-form input[type="checkbox"] { margin-right: 0.6rem; }
    .options-form button { background: #2d3a4b; color: #fff; border: none; border-radius: 12px; padding: 0.7rem 1.6rem; font-size: 1.1rem; cursor: pointer; margin-top: 1rem; }
    .encyclopedia-table { width: 100%; border-collapse: collapse; margin-bottom: 2rem; }
    .encyclopedia-table th, .encyclopedia-table td { border: 1px solid #e0e4ea; padding: 0.7rem 0.5rem; text-align: left; background: #f6f7fb; }
    .encyclopedia-table th { background: #2d3a4b; color: #fff; cursor: pointer; user-select: none; }
    .encyclopedia-table th.sorted-asc::after { content: " ▲"; }
    .encyclopedia-table th.sorted-desc::after { content: " ▼"; }
    .encyclopedia-table tr:hover { background: #e0e4ea; }
    .gallery-section { margin-top: 1.5rem; }
    .gallery-title { font-weight: bold; margin-bottom: 0.7rem; font-size: 1.1rem; }
    .gallery-images { display: flex; flex-wrap: wrap; gap: 1.2rem; }
    .gallery-img-container { position: relative; display: flex; flex-direction: column; align-items: center; }
    .gallery-img { width: 120px; height: 80px; object-fit: cover; border-radius: 8px; border: 1px solid #bbb; background: #eee; margin-bottom: 0.2rem; cursor: pointer; transition: box-shadow 0.2s; }
    .gallery-switch-btn { background: #e0e4ea; border: none; color: #2d3a4b; padding: 0.2rem 0.7rem; border-radius: 8px; cursor: pointer; font-size: 0.9rem; margin-bottom: 0.2rem; margin-top: 0.1rem; }
    .gallery-switch-btn:hover { background: #c2c7d2; }
    .lang-both { margin-top: 0.4em; }
    .lang-label { color: #666; font-size: 0.98em; }
    .lang-name { margin-left: 0.3em; }
    .lang-selected { font-weight: bold; color: #1a1a1a; }
    @media (max-width: 600px) {
      .container { padding: 0.5rem; }
      .quiz-image { width: 98vw; height: auto; }
      .gallery-img { width: 80px; height: 60px; }
      .encyclo-modal { width: 98vw; height: 98vh; }
    }
  </style>
  <style id="dark-mode-style" disabled>
    body { background: #181818 !important; color: #f6f7fb !important; }
    .container { background: #232323 !important; color: #f6f7fb !important; }
    header { background: #121a22 !important; color: #fff !important; }
    nav button { background: #232323 !important; border: 2px solid #f6f7fb !important; color: #f6f7fb !important; }
    nav button.active, nav button:hover { background: #f6f7fb !important; color: #232323 !important; }
    .quiz-image, .result-img-thumb, .gallery-img { background: #333 !important; }
    .modal-img, .encyclo-modal { background: #232323 !important; color: #f6f7fb !important; }
    .autocomplete-list { background: #232323 !important; color: #f6f7fb !important; }
    .autocomplete-item.selected, .autocomplete-item:hover { background: #353535 !important; }
    .options-form button, .close-modal-btn, .close-encyclo-modal-btn { background: #f6f7fb !important; color: #232323 !important; }
    .encyclopedia-table th, .encyclopedia-table td { background: #232323 !important; color: #f6f7fb !important; border-color: #353535 !important; }
    .encyclopedia-table tr:hover { background: #353535 !important; }
    .switch-img-btn, .gallery-switch-btn { background: #353535 !important; color: #f6f7fb !important; }
  </style>
</head>
<body>
<header>
  Body Landmarks
</header>
<nav>
  <button id="nav-quiz" class="active">Quiz</button>
  <button id="nav-options">Options</button>
  <button id="nav-encyclopedia">Encyclopedia</button>
</nav>
<div class="container">
  <!-- Quiz Section -->
  <section id="section-quiz">
    <div id="quiz-mode-selection" style="text-align:center; margin-bottom:2rem;">
      <h3 style="margin-bottom:1rem;">Choose your quiz mode:</h3>
      <div style="display:flex; gap:1rem; justify-content:center;">
        <button id="quiz-mode-hard" class="quiz-mode-btn" style="padding:1rem 2rem; font-size:1.2rem; border-radius:12px; background:#d13a3a; color:#fff; border:none; cursor:pointer; transition:background 0.2s;">Hard Mode (Type answer)</button>
        <button id="quiz-mode-easy" class="quiz-mode-btn" style="padding:1rem 2rem; font-size:1.2rem; border-radius:12px; background:#2c8c2c; color:#fff; border:none; cursor:pointer; transition:background 0.2s;">Easy Mode (Multiple choice)</button>
      </div>
    </div>
    <div id="quiz-content" class="hidden">
      <div id="quiz-timer" class="quiz-timer hidden"></div>
      <div id="quiz-counter" style="text-align:center; margin-bottom:1rem; font-size:1.2rem;"></div>
      <div id="quiz-image-container" class="quiz-image-container"></div>
      <div id="quiz-input-area" class="quiz-input-area">
        <div id="quiz-feedback" class="quiz-feedback"></div>
      </div>
    </div>
  </section>
  <!-- Results Section -->
  <section id="section-results" class="hidden">
    <div id="results-summary" class="results-summary"></div>
    <div id="results-list" class="results-list"></div>
    <button id="results-restart-btn" style="margin-top:2rem;padding:0.7rem 2rem;font-size:1.1rem; border-radius:12px; background:#2d3a4b;color:#fff;border:none;cursor:pointer;">Restart Quiz</button>
  </section>
  <!-- Options Section -->
  <section id="section-options" class="hidden">
    <form id="options-form" class="options-form">
      <div>
        <label for="opt-num-questions" id="lbl-num-questions">Number of questions:</label>
        <input type="number" id="opt-num-questions" min="1" max="30" value="10">
      </div>
      <div>
        <label for="opt-num-choices" id="lbl-num-choices">Number of choices in easy mode:</label>
        <input type="number" id="opt-num-choices" min="2" max="10" value="4">
      </div>
      <div>
        <label>
          <input type="checkbox" id="opt-timer-enabled">
          <span id="lbl-timer-enabled">Enable timer per question</span>
        </label>
        <div id="timer-settings" class="hidden" style="margin-left:2rem;">
          <label for="opt-timer-seconds" id="lbl-timer-seconds">Time per question (seconds):</label>
          <input type="number" id="opt-timer-seconds" min="5" max="120" value="30">
        </div>
      </div>
      <div>
        <label for="opt-feedback-seconds" id="lbl-feedback-seconds">Time to show result (seconds):</label>
        <input type="number" id="opt-feedback-seconds" min="1" max="30" value="3">
      </div>
      <div>
        <label for="opt-lang" id="lbl-lang">Language:</label>
        <select id="opt-lang">
          <option value="FR">Français</option>
          <option value="EN">English</option>
        </select>
      </div>
      <div>
        <label>
          <input type="checkbox" id="opt-darkmode">
          <span id="lbl-darkmode">Dark mode</span>
        </label>
      </div>
      <button type="submit" id="btn-save-options">Save Options</button>
    </form>
  </section>
  <!-- Encyclopedia Section -->
  <section id="section-encyclopedia" class="hidden">
    <table class="encyclopedia-table">
      <thead>
        <tr>
          <th id="sort-name" class="sorted-asc">Name</th>
          <th id="sort-type">Type</th>
          <th id="sort-images">Images</th>
        </tr>
      </thead>
      <tbody id="encyclopedia-list"></tbody>
    </table>
  </section>
</div>
<!-- Modal for large images -->
<div id="modal-bg" class="modal-bg hidden">
  <div class="modal-img">
    <div class="modal-img-tip" id="modal-img-tip">Click the image to switch between variant and original</div>
    <img id="modal-img" src="" alt="Large view">
    <button class="close-modal-btn" onclick="closeModal()" id="btn-close-modal">Close</button>
  </div>
</div>
<!-- Modal for encyclopedia info -->
<div id="encyclo-modal-bg" class="encyclo-modal-bg hidden">
  <div class="encyclo-modal">
    <button class="close-encyclo-modal-btn" onclick="closeEncycloModal()" id="btn-close-encyclo-modal">Close</button>
    <div class="encyclo-modal-content-scroll" id="encyclo-modal-content"></div>
  </div>
</div>
<script>
const GITHUB_RAW_BASE = "https://raw.githubusercontent.com/larbaretier/drawing/main/body/";
const BODY_JSON_URL = GITHUB_RAW_BASE + "body.json";
const IMAGE_PATHS_JSON_URL = GITHUB_RAW_BASE + "image_paths.json";
const ORIGINAL_IMAGES_FOLDER = GITHUB_RAW_BASE + "original_images/";
const SUBFOLDERS = ['cartoon', 'realist', 'photo'];

let bodyList = [];
let nameToElement = {};
let quizOptions = { numQuestions: 10, timerEnabled: false, timerSeconds: 30, feedbackSeconds: 3, darkMode: false, lang: "FR", numChoices: 4 };
let quizState = null;
let encyclopediaSort = { by: 'name', asc: true };
let imageManifest = [];
let imagesByElement = {};
let quizTimerInterval = null;
let feedbackTimer = null;
let encycloModalOpen = false;
let currentLang = "FR";
let darkMode = false;

// For modal image toggling
let modalImgVariant = null;
let modalImgOriginal = null;
let modalImgIsVariant = true;

// i18n
const translations = {
  EN: {
    confirm: "Confirm",
    typeOrSelect: "Type or select the name...",
    showOriginal: "Show original",
    showVariant: "Show variant",
    saveOptions: "Save Options",
    close: "Close",
    numQuestions: "Number of questions:",
    numChoices: "Number of choices in easy mode:",
    enableTimer: 'Enable timer per question',
    timePerQuestion: "Time per question (seconds):",
    feedbackSeconds: "Time to show result (seconds):",
    language: "Language:",
    darkMode: "Dark mode",
    chooseQuizMode: "Choose your quiz mode:",
    hardMode: "Hard Mode (Type answer)",
    easyMode: "Easy Mode (Multiple choice)",
    images: "Images",
    name: "Name",
    type: "Type",
    quiz: "Quiz",
    options: "Options",
    encyclopedia: "Encyclopedia",
    clickToSwitch: "Click the image to switch between variant and original",
    restartQuiz: "Restart Quiz",
    correct: "Correct!",
    wrong: "Wrong!",
    next: "Next",
    quizOver: "Quiz over!",
    score: "Score",
    of: "of",
    noImages: "No images available.",
    nameFR: "French name",
    nameEN: "English name",
    questionCounter: "Question"
  },
  FR: {
    confirm: "Confirmer",
    typeOrSelect: "Tapez ou sélectionnez le nom...",
    showOriginal: "Voir original",
    showVariant: "Voir variante",
    saveOptions: "Enregistrer les options",
    close: "Fermer",
    numQuestions: "Nombre de questions :",
    numChoices: "Nombre de choix en mode facile :",
    enableTimer: 'Activer le minuteur par question',
    timePerQuestion: "Temps par question (secondes) :",
    feedbackSeconds: "Temps d'affichage du résultat (secondes) :",
    language: "Langue :",
    darkMode: "Mode sombre",
    chooseQuizMode: "Choisissez votre mode de quiz :",
    hardMode: "Mode difficile (Saisir la réponse)",
    easyMode: "Mode facile (Choix multiples)",
    images: "Images",
    name: "Nom",
    type: "Type",
    quiz: "Quiz",
    options: "Options",
    encyclopedia: "Encyclopédie",
    clickToSwitch: "Cliquez sur l'image pour alterner entre variante et originale",
    restartQuiz: "Recommencer le quiz",
    correct: "Bonne réponse !",
    wrong: "Mauvaise réponse !",
    next: "Suivant",
    quizOver: "Quiz terminé !",
    score: "Score",
    of: "sur",
    noImages: "Aucune image disponible.",
    nameFR: "Nom français",
    nameEN: "Nom anglais",
    questionCounter: "Question"
  }
};
function t(key) {
  return translations[currentLang][key] || key;
}

function escapeHTML(str) {
  return str.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
function normalizeName(str) {
  return str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, "_").toLowerCase();
}
function getOriginalImagePath(imgFile) {
  const base = imgFile.split('_')[0];
  const ext = imgFile.slice(imgFile.lastIndexOf('.'));
  return `${ORIGINAL_IMAGES_FOLDER}${base}${ext}`;
}
function getRawUrlFromManifestPath(path) {
  return GITHUB_RAW_BASE + path.replace(/\\/g, '/');
}
function parseManifest() {
  imagesByElement = {};
  for (const path of imageManifest) {
    const parts = path.split(/[/\\]/);
    if (parts.length < 4) continue;
    const nom = normalizeName(parts[1]);
    const sub = parts[2];
    const file = parts[3];
    if (!imagesByElement[nom]) imagesByElement[nom] = { cartoon: [], realist: [], photo: [] };
    if (SUBFOLDERS.includes(sub)) {
      imagesByElement[nom][sub].push({
        file,
        url: getRawUrlFromManifestPath(path)
      });
    }
  }
}
window.addEventListener('DOMContentLoaded', async () => {
  showLoading("Chargement...");
  await loadBodyJson();
  await loadImageManifest();
  parseManifest();
  setupNav();
  setupQuiz();
  setupOptions();
  setupEncyclopedia();
  hideLoading();
  showSection('quiz');
  document.getElementById('opt-lang').value = currentLang;
  applyLanguage();
  applyDarkMode();
});

function setLanguage(lang) {
  currentLang = lang;
  quizOptions.lang = lang;
  document.getElementById('opt-lang').value = lang;
  applyLanguage();
  showSection(document.querySelector('nav button.active').id.replace('nav-',''));
}

function applyLanguage() {
  // Nav
  document.getElementById('nav-quiz').textContent = t('quiz');
  document.getElementById('nav-options').textContent = t('options');
  document.getElementById('nav-encyclopedia').textContent = t('encyclopedia');
  
  // Quiz mode selection
  const modeSelection = document.getElementById('quiz-mode-selection');
  if (modeSelection) {
    const title = modeSelection.querySelector('h3');
    if (title) title.textContent = t('chooseQuizMode');
    
    const hardBtn = document.getElementById('quiz-mode-hard');
    if (hardBtn) hardBtn.textContent = t('hardMode');
    
    const easyBtn = document.getElementById('quiz-mode-easy');
    if (easyBtn) easyBtn.textContent = t('easyMode');
  }

  // Quiz
  const submitBtn = document.getElementById('quiz-submit-btn');
  if (submitBtn) submitBtn.textContent = t('confirm');
  
  const answerInput = document.getElementById('quiz-answer');
  if (answerInput) answerInput.placeholder = t('typeOrSelect');

  // Options
  const numQuestionsLabel = document.getElementById('lbl-num-questions');
  if (numQuestionsLabel) numQuestionsLabel.textContent = t('numQuestions');
  
  const numChoicesLabel = document.getElementById('lbl-num-choices');
  if (numChoicesLabel) numChoicesLabel.textContent = t('numChoices');
  
  const timerEnabledLabel = document.getElementById('lbl-timer-enabled');
  if (timerEnabledLabel) timerEnabledLabel.textContent = t('enableTimer');
  
  const timerSecondsLabel = document.getElementById('lbl-timer-seconds');
  if (timerSecondsLabel) timerSecondsLabel.textContent = t('timePerQuestion');
  
  const feedbackSecondsLabel = document.getElementById('lbl-feedback-seconds');
  if (feedbackSecondsLabel) feedbackSecondsLabel.textContent = t('feedbackSeconds');
  
  const langLabel = document.getElementById('lbl-lang');
  if (langLabel) langLabel.textContent = t('language');
  
  const darkModeLabel = document.getElementById('lbl-darkmode');
  if (darkModeLabel) darkModeLabel.textContent = t('darkMode');
  
  const saveOptionsBtn = document.getElementById('btn-save-options');
  if (saveOptionsBtn) saveOptionsBtn.textContent = t('saveOptions');

  // Encyclopedia Table
  const nameHeader = document.getElementById('sort-name');
  if (nameHeader) nameHeader.textContent = t('name');
  
  const typeHeader = document.getElementById('sort-type');
  if (typeHeader) typeHeader.textContent = t('type');
  
  const imagesHeader = document.getElementById('sort-images');
  if (imagesHeader) imagesHeader.textContent = t('images');

  // Modal
  const closeModalBtn = document.getElementById('btn-close-modal');
  if (closeModalBtn) closeModalBtn.textContent = t('close');
  
  const closeEncycloModalBtn = document.getElementById('btn-close-encyclo-modal');
  if (closeEncycloModalBtn) closeEncycloModalBtn.textContent = t('close');
  
  const modalImgTip = document.getElementById('modal-img-tip');
  if (modalImgTip) modalImgTip.textContent = t('clickToSwitch');

  // Results
  const restartBtn = document.getElementById('results-restart-btn');
  if (restartBtn) restartBtn.textContent = t('restartQuiz');
}

async function loadBodyJson() {
  const resp = await fetch(BODY_JSON_URL);
  bodyList = await resp.json();
  nameToElement = {};
  for (const elem of bodyList) nameToElement[elem.nom] = elem;
}
async function loadImageManifest() {
  const resp = await fetch(IMAGE_PATHS_JSON_URL);
  imageManifest = await resp.json();
}

function setupNav() {
  document.getElementById('nav-quiz').onclick = () => showSection('quiz');
  document.getElementById('nav-options').onclick = () => showSection('options');
  document.getElementById('nav-encyclopedia').onclick = () => showSection('encyclopedia');
}

function showSection(section) {
  document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
  document.getElementById('nav-' + section).classList.add('active');
  document.getElementById('section-quiz').classList.toggle('hidden', section !== 'quiz');
  document.getElementById('section-results').classList.add('hidden');
  document.getElementById('section-options').classList.toggle('hidden', section !== 'options');
  document.getElementById('section-encyclopedia').classList.toggle('hidden', section !== 'encyclopedia');
  
  if (section === 'quiz') {
    // Show mode selection and hide quiz content
    document.getElementById('quiz-mode-selection').classList.remove('hidden');
    document.getElementById('quiz-content').classList.add('hidden');
  }
  if (section === 'encyclopedia') renderEncyclopediaTable();
}

function showLoading(msg) {
  let el = document.getElementById('loading-indicator');
  if (!el) {
    el = document.createElement('div');
    el.id = 'loading-indicator';
    el.style = "position:fixed;top:0;left:0;width:100vw;height:100vh;background:#fff9f9ee;z-index:9999;display:flex;align-items:center;justify-content:center;font-size:2rem;";
    document.body.appendChild(el);
  }
  el.textContent = msg || "Loading...";
  el.style.display = 'flex';
}
function hideLoading() {
  let el = document.getElementById('loading-indicator');
  if (el) el.style.display = 'none';
}

// --- Quiz logic ---
function setupQuiz() {
  // Set up quiz mode selection
  document.getElementById('quiz-mode-hard').onclick = () => {
    quizOptions.quizMode = 'hard';
    startQuiz();
  };
  document.getElementById('quiz-mode-easy').onclick = () => {
    quizOptions.quizMode = 'easy';
    startQuiz();
  };
}

function startQuiz() {
  // Hide mode selection and show quiz content
  document.getElementById('quiz-mode-selection').classList.add('hidden');
  document.getElementById('quiz-content').classList.remove('hidden');

  quizState = {
    questions: generateQuizQuestions(),
    current: 0,
    answers: [],
    timer: quizOptions.timerEnabled ? quizOptions.timerSeconds : null,
    timerRunning: false,
    feedbackTimer: null
  };
  document.getElementById('section-results').classList.add('hidden');
  showQuizQuestion();
}

function generateQuizQuestions() {
  // Only pick elements with at least 1 image
  let eligible = bodyList.filter(e => getImagesCount(e) > 0);
  eligible = shuffle([...eligible]);
  let n = Math.min(quizOptions.numQuestions, eligible.length);
  return eligible.slice(0, n).map(e => ({
    element: e,
    image: pickRandomImage(e)
  }));
}
function pickRandomImage(element) {
  const norm = normalizeName(element.nom);
  if (!imagesByElement[norm]) return null;
  let allImgs = [];
  for (const sub of SUBFOLDERS) allImgs = allImgs.concat(imagesByElement[norm][sub]);
  if (allImgs.length === 0) return null;
  return allImgs[Math.floor(Math.random() * allImgs.length)];
}

let quizCurrentImageIsVariant = true;
let quizCurrentImageVariantUrl = "";
let quizCurrentImageOriginalUrl = "";

function showQuizQuestion() {
  if (feedbackTimer) { clearTimeout(feedbackTimer); feedbackTimer = null; }
  const q = quizState.questions[quizState.current];
  const elem = q.element;
  const img = q.image;

  // Clear feedback
  const feedbackDiv = document.getElementById('quiz-feedback');
  if (feedbackDiv) {
    feedbackDiv.innerHTML = '';
  }

  // Update question counter
  const counterEl = document.getElementById('quiz-counter');
  if (counterEl) {
    counterEl.textContent = `${t('questionCounter')} ${quizState.current + 1}/${quizState.questions.length}`;
  }

  // Image
  const imgDiv = document.getElementById('quiz-image-container');
  if (imgDiv) {
    imgDiv.innerHTML = '';
    quizCurrentImageIsVariant = true;
    if (img) {
      quizCurrentImageVariantUrl = img.url;
      quizCurrentImageOriginalUrl = getOriginalImagePath(img.file);
      const imageEl = document.createElement('img');
      imageEl.className = 'quiz-image';
      imageEl.src = quizCurrentImageVariantUrl;
      imageEl.alt = elem.nom;
      imageEl.onclick = () => showModalImage(quizCurrentImageIsVariant ? quizCurrentImageVariantUrl : quizCurrentImageOriginalUrl, quizCurrentImageIsVariant ? quizCurrentImageOriginalUrl : quizCurrentImageVariantUrl);
      imgDiv.appendChild(imageEl);

      // Show original/variant toggle button
      const btn = document.createElement('button');
      btn.className = 'switch-img-btn';
      btn.textContent = t('showOriginal');
      btn.onclick = (e) => {
        e.preventDefault();
        quizCurrentImageIsVariant = !quizCurrentImageIsVariant;
        imageEl.src = quizCurrentImageIsVariant ? quizCurrentImageVariantUrl : quizCurrentImageOriginalUrl;
        btn.textContent = quizCurrentImageIsVariant ? t('showOriginal') : t('showVariant');
      };
      imgDiv.appendChild(btn);
    }
  }

  // Answer input or multiple choice
  const inputArea = document.getElementById('quiz-input-area');
  if (inputArea) {
    // Clear previous content except feedback
    inputArea.innerHTML = '';
    if (feedbackDiv) {
      inputArea.appendChild(feedbackDiv);
    }

    if (quizOptions.quizMode === 'hard') {
      // Hard mode - text input with autocomplete
      const input = document.createElement('input');
      input.id = 'quiz-answer';
      input.type = 'text';
      input.placeholder = t('typeOrSelect');
      input.style = 'font-size:1.1rem; padding:0.5rem; width:90%; border-radius:8px; border:1px solid #bbb;';
      input.addEventListener('input', debounce(showAutocomplete, 100));
      input.addEventListener('focus', showAutocomplete);
      input.addEventListener('keydown', (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          submitQuizAnswer();
        }
      });
      inputArea.appendChild(input);

      const autocompleteList = document.createElement('div');
      autocompleteList.id = 'autocomplete-list';
      autocompleteList.className = 'autocomplete-list hidden';
      inputArea.appendChild(autocompleteList);

      const submitBtn = document.createElement('button');
      submitBtn.id = 'quiz-submit-btn';
      submitBtn.textContent = t('confirm');
      submitBtn.style = 'margin-top:0.5rem;padding:0.5rem 2rem;font-size:1.1rem; border-radius:12px; background:#2d3a4b;color:#fff;border:none;cursor:pointer;';
      submitBtn.onclick = () => submitQuizAnswer();
      inputArea.appendChild(submitBtn);
    } else {
      // Easy mode - multiple choice
      const correctName = currentLang === 'FR' ? (elem.FR || elem.nom) : (elem.EN || elem.nom);
      
      // Get wrong answers (numChoices - 1 wrong answers)
      let wrongAnswers = bodyList
        .filter(e => e.nom !== elem.nom)
        .map(e => currentLang === 'FR' ? (e.FR || e.nom) : (e.EN || e.nom));
      wrongAnswers = shuffle(wrongAnswers).slice(0, quizOptions.numChoices - 1);
      
      // Combine with correct answer and shuffle
      let allAnswers = [...wrongAnswers, correctName];
      allAnswers = shuffle(allAnswers);

      // Create a container for the answer buttons
      const answersContainer = document.createElement('div');
      answersContainer.style.display = 'flex';
      answersContainer.style.flexDirection = 'column';
      answersContainer.style.alignItems = 'center';
      answersContainer.style.width = '100%';
      inputArea.appendChild(answersContainer);

      // Create buttons for each answer
      allAnswers.forEach(answer => {
        const btn = document.createElement('button');
        btn.className = 'quiz-choice-btn';
        btn.textContent = answer;
        btn.style = 'margin:0.5rem;padding:0.7rem 1.5rem;font-size:1.1rem;border-radius:12px;background:#2d3a4b;color:#fff;border:none;cursor:pointer;width:80%;transition:background-color 0.2s;';
        btn.onclick = () => {
          // Make all buttons darker first
          document.querySelectorAll('.quiz-choice-btn').forEach(b => {
            b.style.backgroundColor = '#2d3a4b';
          });
          // Make clicked button lighter
          btn.style.backgroundColor = '#4a5c73';
          const correct = answer === correctName;
          submitQuizAnswer(false, answer, correct);
        };
        answersContainer.appendChild(btn);
      });
    }
  }

  // Timer
  const timerEl = document.getElementById('quiz-timer');
  if (quizOptions.timerEnabled && timerEl) {
    timerEl.classList.remove('hidden');
    quizState.timer = quizOptions.timerSeconds;
    timerEl.textContent = quizState.timer + 's';
    if (quizTimerInterval) clearInterval(quizTimerInterval);
    quizTimerInterval = setInterval(() => {
      quizState.timer--;
      timerEl.textContent = quizState.timer + 's';
      if (quizState.timer <= 0) {
        clearInterval(quizTimerInterval);
        quizTimerInterval = null;
        submitQuizAnswer(true);
      }
    }, 1000);
  } else if (timerEl) {
    timerEl.classList.add('hidden');
    if (quizTimerInterval) { clearInterval(quizTimerInterval); quizTimerInterval = null; }
  }
}

function submitQuizAnswer(timeout = false, selectedAnswer = null, isCorrect = null) {
  const q = quizState.questions[quizState.current];
  const elem = q.element;
  const correctName = currentLang === 'FR' ? (elem.FR || elem.nom) : (elem.EN || elem.nom);
  
  let answer, correct;
  if (quizOptions.quizMode === 'hard') {
    answer = document.getElementById('quiz-answer').value.trim();
    correct = !timeout && answer.localeCompare(correctName, undefined, { sensitivity: 'accent' }) === 0;
  } else {
    answer = selectedAnswer;
    correct = isCorrect;
  }

  quizState.answers.push({
    element: elem,
    image: q.image,
    answer,
    correct,
    timeout
  });

  if (quizTimerInterval) { clearInterval(quizTimerInterval); quizTimerInterval = null; }
  showQuizFeedback(correct, correctName, q.image);
}

function showQuizFeedback(correct, correctName, img) {
  const feedbackDiv = document.getElementById('quiz-feedback');
  if (!feedbackDiv) return;
  
  feedbackDiv.innerHTML = '';
  if (correct) {
    feedbackDiv.innerHTML = `<span class="result-correct">${t('correct')}</span>`;
  } else {
    feedbackDiv.innerHTML = `<span class="result-wrong">${t('wrong')}</span><br>${escapeHTML(correctName)}`;
  }

  // Add line break
  feedbackDiv.appendChild(document.createElement('br'));

  // Show next button
  const nextBtn = document.createElement('button');
  nextBtn.id = 'quiz-next-btn';
  nextBtn.textContent = t('next');
  nextBtn.style = 'margin-top:1rem;padding:0.5rem 2rem;font-size:1.1rem; border-radius:12px; background:#2d3a4b;color:#fff;border:none;cursor:pointer;';
  nextBtn.onclick = () => {
    clearInterval(feedbackTimer);
    feedbackTimer = null;
    quizState.current++;
    if (quizState.current < quizState.questions.length) {
      showQuizQuestion();
    } else {
      showQuizResults();
    }
  };
  feedbackDiv.appendChild(nextBtn);

  // Timer for feedback
  let seconds = quizOptions.feedbackSeconds || 3;
  let timerSpan = document.createElement('span');
  timerSpan.style.marginLeft = "1em";
  timerSpan.style.fontWeight = "bold";
  timerSpan.textContent = ` (${seconds}s)`;
  feedbackDiv.appendChild(timerSpan);

  let countdown = seconds;
  feedbackTimer = setInterval(() => {
    countdown--;
    timerSpan.textContent = ` (${countdown}s)`;
    if (countdown <= 0) {
      clearInterval(feedbackTimer);
      feedbackTimer = null;
      quizState.current++;
      if (quizState.current < quizState.questions.length) {
        showQuizQuestion();
      } else {
        showQuizResults();
      }
    }
  }, 1000);
}

function showQuizResults() {
  if (feedbackTimer) { clearTimeout(feedbackTimer); feedbackTimer = null; }
  document.getElementById('section-quiz').classList.add('hidden');
  document.getElementById('section-results').classList.remove('hidden');
  // Score
  const total = quizState.answers.length;
  const correct = quizState.answers.filter(a => a.correct).length;
  document.getElementById('results-summary').textContent = `${t('score')}: ${correct} ${t('of')} ${total}`;
  // List
  const list = document.getElementById('results-list');
  list.innerHTML = '';
  quizState.answers.forEach((a, idx) => {
    const div = document.createElement('div');
    div.className = 'result-item';
    if (a.image) {
      const img = document.createElement('img');
      img.className = 'result-img-thumb';
      img.src = a.image.url;
      img.alt = currentLang === 'FR' ? (a.element.FR || a.element.nom) : (a.element.EN || a.element.nom);
      img.onclick = () => showModalImage(a.image.url, getOriginalImagePath(a.image.file));
      div.appendChild(img);
    }
    const details = document.createElement('div');
    details.className = 'result-details';
    const displayName = currentLang === 'FR' ? (a.element.FR || a.element.nom) : (a.element.EN || a.element.nom);
    details.innerHTML = `<strong>${escapeHTML(displayName)}</strong><br>
      <span class="${a.correct ? 'result-correct' : 'result-wrong'}">${a.correct ? t('correct') : t('wrong')}</span>`;
    if (!a.correct && a.answer) {
      details.innerHTML += `<br><span style="color:#888">${escapeHTML(a.answer)}</span>`;
    }
    div.appendChild(details);
    list.appendChild(div);
  });
  document.getElementById('results-restart-btn').onclick = () => {
    document.getElementById('section-results').classList.add('hidden');
    document.getElementById('section-quiz').classList.remove('hidden');
    document.getElementById('quiz-mode-selection').classList.remove('hidden');
    document.getElementById('quiz-content').classList.add('hidden');
  };
}

// --- Autocomplete ---
function showAutocomplete() {
  const input = document.getElementById('quiz-answer');
  const val = input.value.trim().toLowerCase();
  const list = document.getElementById('autocomplete-list');
  if (!val) {
    list.classList.add('hidden');
    list.innerHTML = '';
    return;
  }
  const suggestions = bodyList
    .filter(e => {
      const name = currentLang === 'FR' ? (e.FR || e.nom) : (e.EN || e.nom);
      return name.toLowerCase().includes(val);
    })
    .slice(0, 10);
  if (suggestions.length === 0) {
    list.classList.add('hidden');
    list.innerHTML = '';
    return;
  }
  list.innerHTML = '';
  suggestions.forEach((e, idx) => {
    const item = document.createElement('div');
    item.className = 'autocomplete-item';
    item.textContent = currentLang === 'FR' ? (e.FR || e.nom) : (e.EN || e.nom);
    item.onclick = () => {
      input.value = currentLang === 'FR' ? (e.FR || e.nom) : (e.EN || e.nom);
      list.classList.add('hidden');
      list.innerHTML = '';
    };
    list.appendChild(item);
  });
  list.classList.remove('hidden');
}

// --- Options logic ---
function setupOptions() {
  document.getElementById('opt-lang').onchange = (e) => setLanguage(e.target.value);
  document.getElementById('opt-timer-enabled').onchange = (e) => {
    document.getElementById('timer-settings').classList.toggle('hidden', !e.target.checked);
  };
  document.getElementById('opt-darkmode').onchange = (e) => {
    darkMode = e.target.checked;
    quizOptions.darkMode = darkMode;
    applyDarkMode();
  };
  document.getElementById('options-form').onsubmit = (e) => {
    e.preventDefault();
    quizOptions.numQuestions = parseInt(document.getElementById('opt-num-questions').value, 10);
    quizOptions.numChoices = parseInt(document.getElementById('opt-num-choices').value, 10);
    quizOptions.timerEnabled = document.getElementById('opt-timer-enabled').checked;
    quizOptions.timerSeconds = parseInt(document.getElementById('opt-timer-seconds').value, 10);
    quizOptions.feedbackSeconds = parseInt(document.getElementById('opt-feedback-seconds').value, 10);
    quizOptions.lang = document.getElementById('opt-lang').value;
    quizOptions.darkMode = document.getElementById('opt-darkmode').checked;
    setLanguage(quizOptions.lang);
    applyDarkMode();
    showSection('quiz');
  };
  // Set initial values
  document.getElementById('opt-num-questions').value = quizOptions.numQuestions;
  document.getElementById('opt-num-choices').value = quizOptions.numChoices;
  document.getElementById('opt-timer-enabled').checked = quizOptions.timerEnabled;
  document.getElementById('opt-timer-seconds').value = quizOptions.timerSeconds;
  document.getElementById('opt-feedback-seconds').value = quizOptions.feedbackSeconds;
  document.getElementById('opt-darkmode').checked = quizOptions.darkMode;
  document.getElementById('timer-settings').classList.toggle('hidden', !quizOptions.timerEnabled);
}

function applyDarkMode() {
  darkMode = quizOptions.darkMode;
  document.getElementById('dark-mode-style').disabled = !darkMode;
}

// --- Encyclopedia logic ---
function setupEncyclopedia() {
  document.getElementById('sort-name').onclick = () => { encyclopediaSort.by = 'name'; encyclopediaSort.asc = !encyclopediaSort.asc; renderEncyclopediaTable(); };
  document.getElementById('sort-type').onclick = () => { encyclopediaSort.by = 'type'; encyclopediaSort.asc = !encyclopediaSort.asc; renderEncyclopediaTable(); };
  document.getElementById('sort-images').onclick = () => { encyclopediaSort.by = 'images'; encyclopediaSort.asc = !encyclopediaSort.asc; renderEncyclopediaTable(); };
}

function renderEncyclopediaTable() {
  const tbody = document.getElementById('encyclopedia-list');
  tbody.innerHTML = '';
  // Sort
  let sorted = [...bodyList];
  sorted.sort((a, b) => {
    let valA, valB;
    if (encyclopediaSort.by === 'name') {
      valA = a.nom.toLowerCase();
      valB = b.nom.toLowerCase();
    } else if (encyclopediaSort.by === 'type') {
      valA = a.type.toLowerCase();
      valB = b.type.toLowerCase();
    } else if (encyclopediaSort.by === 'images') {
      valA = getImagesCount(a);
      valB = getImagesCount(b);
    }
    if (valA < valB) return encyclopediaSort.asc ? -1 : 1;
    if (valA > valB) return encyclopediaSort.asc ? 1 : -1;
    return 0;
  });
  for (const elem of sorted) {
    const tr = document.createElement('tr');
    const displayName = currentLang === 'FR' ? (elem.FR || elem.nom) : (elem.EN || elem.nom);
    tr.innerHTML = `<td>${escapeHTML(displayName)}</td>
      <td>${escapeHTML(elem.type)}</td>
      <td style="text-align:center">${getImagesCount(elem)}</td>`;
    tr.style.cursor = 'pointer';
    tr.onclick = () => showEncyclopediaModal(elem);
    tbody.appendChild(tr);
  }
}

function getImagesCount(elem) {
  const norm = normalizeName(elem.nom);
  if (!imagesByElement[norm]) return 0;
  return (imagesByElement[norm].cartoon.length + imagesByElement[norm].realist.length + imagesByElement[norm].photo.length);
}

function showEncyclopediaModal(elem) {
  const content = document.getElementById('encyclo-modal-content');
  content.innerHTML = ''; // Clear content first
  
  // Create header content
  const header = document.createElement('div');
  header.innerHTML = `<h2>${escapeHTML(elem.nom)}</h2>
    <p><strong>${t('nameEN')}:</strong> ${escapeHTML(elem.EN || elem.nom)}</p>
    <p><strong>${t('nameFR')}:</strong> ${escapeHTML(elem.FR || elem.nom)}</p>
    <p><strong>${t('type')}:</strong> ${escapeHTML(elem.type)}</p>`;
  content.appendChild(header);

  // Images by category
  const norm = normalizeName(elem.nom);
  if (imagesByElement[norm]) {
    let hasAnyImages = false;
    for (const sub of SUBFOLDERS) {
      const imgs = imagesByElement[norm][sub];
      if (imgs.length > 0) {
        hasAnyImages = true;
        
        // Create section
        const section = document.createElement('div');
        section.className = 'gallery-section';
        
        // Add title
        const title = document.createElement('div');
        title.className = 'gallery-title';
        title.textContent = sub.charAt(0).toUpperCase() + sub.slice(1);
        section.appendChild(title);
        
        // Create image container
        const imgDiv = document.createElement('div');
        imgDiv.style.display = 'flex';
        imgDiv.style.flexWrap = 'wrap';
        imgDiv.style.gap = '10px';
        
        imgs.forEach(img => {
          const container = document.createElement('div');
          container.style.display = 'flex';
          container.style.flexDirection = 'column';
          container.style.alignItems = 'center';
          
          const im = document.createElement('img');
          im.src = img.url;
          im.alt = elem.nom;
          im.style.width = '100px';
          im.style.height = '70px';
          im.style.objectFit = 'cover';
          im.style.borderRadius = '6px';
          im.style.cursor = 'pointer';
          im.onclick = () => {
            modalImgVariant = img.url;
            modalImgOriginal = getOriginalImagePath(img.file);
            modalImgIsVariant = true;
            const modal = document.getElementById('modal-bg');
            const modalImg = document.getElementById('modal-img');
            modalImg.src = modalImgVariant;
            modalImg.onclick = () => {
              modalImgIsVariant = !modalImgIsVariant;
              modalImg.src = modalImgIsVariant ? modalImgVariant : modalImgOriginal;
            };
            modal.classList.remove('hidden');
          };
          
          const btn = document.createElement('button');
          btn.className = 'gallery-switch-btn';
          btn.textContent = t('showOriginal');
          let isOriginal = false;
          btn.onclick = () => {
            isOriginal = !isOriginal;
            im.src = isOriginal ? getOriginalImagePath(img.file) : img.url;
            btn.textContent = isOriginal ? t('showVariant') : t('showOriginal');
          };
          
          container.appendChild(im);
          container.appendChild(btn);
          imgDiv.appendChild(container);
        });
        
        section.appendChild(imgDiv);
        content.appendChild(section);
      }
    }
    if (!hasAnyImages) {
      const noImages = document.createElement('div');
      noImages.innerHTML = `<em>${t('noImages')}</em>`;
      content.appendChild(noImages);
    }
  } else {
    const noImages = document.createElement('div');
    noImages.innerHTML = `<em>${t('noImages')}</em>`;
    content.appendChild(noImages);
  }
  
  document.getElementById('encyclo-modal-bg').classList.remove('hidden');
}

// --- Modal logic ---
function showModalImage(variantUrl, originalUrl) {
  modalImgVariant = variantUrl;
  modalImgOriginal = originalUrl;
  modalImgIsVariant = true;
  const modal = document.getElementById('modal-bg');
  const img = document.getElementById('modal-img');
  img.src = modalImgVariant;
  img.onclick = () => {
    modalImgIsVariant = !modalImgIsVariant;
    img.src = modalImgIsVariant ? modalImgVariant : modalImgOriginal;
  };
  modal.classList.remove('hidden');
}
function closeModal() {
  document.getElementById('modal-bg').classList.add('hidden');
}
function closeEncycloModal() {
  document.getElementById('encyclo-modal-bg').classList.add('hidden');
}

// --- Utility ---
function debounce(fn, ms) {
  let t;
  return function(...args) {
    clearTimeout(t);
    t = setTimeout(() => fn.apply(this, args), ms);
  }
}
</script>
</body>
</html>